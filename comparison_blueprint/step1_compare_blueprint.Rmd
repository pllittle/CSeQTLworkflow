
---
title: "Comparison with BLUEPRINT results"
author: "Si Liu and Wei Sun"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: journal
    highlight: tango
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: false
    number_sections: false
  df_print: paged
params:
  ot_q_cutoff: 5e-5
  cs_q_cutoff: 5e-3
  ot_fold_cutoff: 1.5
  cs_fold_cutoff: 1.0
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(width = 80)
```

# Setup

## Load R libraries

```{r load_libraries, warning = FALSE, message = FALSE}
library(data.table)
library(readxl)
library(stringr)
library(tidyr)
library(reshape2)

library(ggplot2)
library(ggpubr)
theme_set(theme_classic())

Other_method = "BLUEPRINT"

dim1 <- function(x){if(is.vector(x)) length(x) else dim(x)}

get_pi0 <- function(pval){
  mean(pval==1, na.rm = TRUE) + 
  2*sum((pval > 0.5) & (pval < 1), na.rm = TRUE) / sum(!is.na(pval))
}

# params = list(ot_q_cutoff=5e-5, cs_q_cutoff=5e-3, ot_fold_cutoff=1.5, cs_fold_cutoff=1.0)
ot_q_cutoff = params$ot_q_cutoff
cs_q_cutoff = params$cs_q_cutoff
ot_fold_cutoff = params$ot_fold_cutoff
cs_fold_cutoff = params$cs_fold_cutoff

cat("ot_q_cutoff: ",  ot_q_cutoff,  "\n")
cat("cs_q_cutoff: ",  cs_q_cutoff,  "\n")
cat("ot_fold_cutoff: ",  ot_fold_cutoff,  "\n")
cat("cs_fold_cutoff: ",  cs_fold_cutoff,  "\n")

config = sprintf("ot_cs_q_%.0e_%.0e_fold_%.1f_%.1f", 
                 ot_q_cutoff, cs_q_cutoff, ot_fold_cutoff, cs_fold_cutoff)
config
```

## Data directory and file names

- ```res_all``` has the most significant eQTL for all the genes (not just the eGenes).  

```{r}
res_all  = "../../CSeQTL/data2share/GTExBlood_eqtls.rds"
res_bp   = "../../CSeQTL/data2share/BLUEPRINT_eqtls.rds"

cts_list = list(CD4T = "EGAD00001002671",
                Monocyte = "EGAD00001002674",
                Neutrophil = "EGAD00001002675")
```

# Check data

## Results from CSeQTL

```{r}
rall = readRDS(res_all)
names(rall)
lapply(rall, dim1)

rall$summary[1:5,]
rall$eqtl[1:2,]
summary(rall$eqtl$PVAL)
rall$eqtl[which(is.na(rall$eqtl$PVAL))[1:5],]

table(rall$eqtl$CELLTYPE, useNA = "ifany")

table(rall$eqtl$trim, useNA = "ifany")
table(rall$eqtl$perm, useNA = "ifany")
table(rall$eqtl$MODEL, useNA = "ifany")

cs_result = rall$eqtl[rall$eqtl$trim==TRUE & 
                        rall$eqtl$perm==FALSE & 
                        rall$eqtl$MODEL=="cseqtl" & 
                        (!is.na(rall$eqtl$PVAL)), ]
dim(cs_result)
cs_result[1:2,]
table(cs_result$CELLTYPE)

cs_result = cs_result[-which(cs_result$CELLTYPE %in% 
                               c("Bulk", "OTHER")),]
dim(cs_result)
cs_result[1:2,]
table(cs_result$CELLTYPE)

cs_gene_list = tapply(cs_result$ENSG, 
                      cs_result$CELLTYPE, function(v){v})
sapply(cs_gene_list, length)
```

## Results from Blueprint

```{r}
bp = readRDS(res_bp)
names(bp)
lapply(bp, dim1)

bp$summary[1:5,]
bp$eqtl[1:2,]

table(bp$eqtl$AF, bp$eqtl$CT2, useNA = "ifany")

table(bp$eqtl$CELLTYPE, useNA = "ifany")
table(bp$eqtl$CT2, useNA = "ifany")

table(bp$eqtl$trim,  useNA = "ifany")
table(bp$eqtl$perm,  useNA = "ifany")
table(bp$eqtl$MODEL, useNA = "ifany")
summary(bp$eqtl$PVAL)

bp_result = bp$eqtl[bp$eqtl$trim==TRUE & bp$eqtl$perm==FALSE & 
                     bp$eqtl$MODEL=="cseqtl", ]
dim(bp_result)
bp_result[1:2,]
table(bp_result$CT2)
stopifnot(!any(is.na(bp_result$PVAL)))

# remove version from ENSEMBL ID does not help
rm_version <- function(id_w_version){
   gsub("\\..*", "", id_w_version)
}

table(cs_result$ENSG %in% bp_result$ENSG)

cs_result$ENSG[1:5]
rm_version(cs_result$ENSG)[1:5]
table(rm_version(cs_result$ENSG) %in% rm_version(bp_result$ENSG))

bp_gene_list = tapply(bp_result$ENSG, 
                          bp_result$CT2, function(v){v})
sapply(bp_gene_list, length)
```

## Define eQTLs, considering both p-value and effect sizes. 

```{r}
table(bp_result$qvalue < 1e-100, useNA = 'ifany')
table(cs_result$qvalue < 1e-100, useNA = 'ifany')

bp_result$qvalue[bp_result$qvalue < 1e-100] = 1e-100
cs_result$qvalue[cs_result$qvalue < 1e-100] = 1e-100

summary(bp_result$ETA)
ggplot(bp_result, aes(x=log10(ETA), y=-log10(qvalue))) + 
  geom_point(size = 1, alpha = 0.5) + 
  geom_hline(yintercept=-log10(ot_q_cutoff), col="red") + 
  geom_vline(xintercept=log10(ot_fold_cutoff), col="red") + 
  geom_vline(xintercept=-log10(ot_fold_cutoff), col="red")

summary(cs_result$ETA)
ggplot(cs_result, aes(x=log10(ETA), y=-log10(qvalue))) + 
  geom_point(size = 1, alpha = 0.5) + 
  geom_hline(yintercept=-log10(cs_q_cutoff), col="red") + 
  geom_vline(xintercept=log10(cs_fold_cutoff), col="red") + 
  geom_vline(xintercept=-log10(cs_fold_cutoff), col="red")

table(abs(log10(bp_result$ETA)) >= log10(ot_fold_cutoff), 
      bp_result$qvalue < ot_q_cutoff)

table(abs(log10(cs_result$ETA)) >= log10(cs_fold_cutoff), 
      cs_result$qvalue < cs_q_cutoff)

ww1 = abs(log10(bp_result$ETA)) >= log10(ot_fold_cutoff)
ww1 = ww1 & bp_result$qvalue < ot_q_cutoff

bp_result = bp_result[ww1,]

ww2 = abs(log10(cs_result$ETA)) >= log10(cs_fold_cutoff)
ww2 = ww2 & cs_result$qvalue < cs_q_cutoff

cs_result_all = cs_result
cs_result = cs_result[ww2,]

table(cs_result$CELLTYPE, useNA='ifany')
table(bp_result$CT2, useNA='ifany')
```

##  Cell types

ot_cell_types are the cell types considered by the other study
```{r}
cs_cell_types = c("B", "CD4T", "CD8T", "Monocyte", "NK", "Neutrophil")
ot_cell_types = c("CD4T", "Monocyte", "Neutrophil")
```

## Further filter eQTLs

To avoid unbalanced number of eQTLs across cell types, keep top 500 eGenes for BLUEPRINT study and top 300 eGenes for GTEx brain study. 

```{r}
ot_result = bp_result
ot_result_tmp = NULL

for (i in 1:length(ot_cell_types)){
  ot_ct = ot_cell_types[i]
  ot_ct_result = ot_result[ot_result$CT2 == ot_ct,]
  
  if(nrow(ot_ct_result) > 500){
    ot_ct_result = ot_ct_result[order(ot_ct_result$qvalue),]
    ot_ct_result = ot_ct_result[1:500,]
  }
  
  ot_result_tmp = rbind(ot_result_tmp, ot_ct_result)
}
ot_result = ot_result_tmp
table(ot_result$CT2, useNA='ifany')


cs_result_tmp = NULL

for (j in 1:length(cs_cell_types)){
  cs_ct = cs_cell_types[j]
  cs_ct_result = cs_result[cs_result$CELLTYPE == cs_ct,]
  
  if(nrow(cs_ct_result) > 300){
    cs_ct_result = cs_ct_result[order(cs_ct_result$qvalue),]
    cs_ct_result = cs_ct_result[1:300,]
  }
  
  cs_result_tmp = rbind(cs_result_tmp, cs_ct_result)
}
cs_result = cs_result_tmp
table(cs_result$CELLTYPE, useNA='ifany')

```

# Comparison

Loop through each pair between the 3 blueprint cell types and the 7 CSeQTL cell types. 

```{r}
mat_cs_vs_ot= matrix(NA, nrow=length(cs_cell_types), 
                      ncol=length(ot_cell_types))
rownames(mat_cs_vs_ot) = cs_cell_types
colnames(mat_cs_vs_ot) = ot_cell_types

prop_mat_ot      = mat_cs_vs_ot
prop_mat_cs      = mat_cs_vs_ot
prop_mat_union   = mat_cs_vs_ot
ratio_obs_vs_exp = mat_cs_vs_ot
relative_ratios  = mat_cs_vs_ot
fisher_mat       = mat_cs_vs_ot
pi1_hat_mat_ot   = mat_cs_vs_ot
n_eGenes_ot      = mat_cs_vs_ot

# the union of the CSeQTL eGenes across cell types
union_cs_eGenes = unique(cs_result$ENSG)
length(union_cs_eGenes)

pdf(width = 12, height = 6, 
    sprintf("figures/%s_eGenes_CSeQTL_pval_hist.pdf", Other_method))

for (i in 1:length(ot_cell_types)){
  
  ot_ct = ot_cell_types[i]
  ot_ct_result = ot_result[ot_result$CT2 == ot_ct,]

  ot_eGenes_i = unique(ot_ct_result$ENSG)

  # calculate base_union_ratio:
  # among the CSeQTL eGenes across all the cell types, what proportion 
  # overlaps with the eGenes in the i-th cell type by the other study
  union_cs_eGenes_i = intersect(union_cs_eGenes, bp_gene_list[[ot_ct]])
  
  base_union_ratio = length(intersect(ot_eGenes_i, union_cs_eGenes_i))
  base_union_ratio = base_union_ratio / length(union_cs_eGenes_i)

  # list of plots
  p_ct_list = list()

  for (j in 1:length(cs_cell_types)){
    
    cs_ct = cs_cell_types[j]
    cs_ct_result = cs_result[cs_result$CELLTYPE == cs_ct,]
    
    overlap_considered = intersect(cs_gene_list[[cs_ct]], 
                                   bp_gene_list[[ot_ct]])

    ot_ij_eGenes = intersect(ot_ct_result$ENSG, overlap_considered)
    cs_ij_eGenes = intersect(cs_ct_result$ENSG, overlap_considered)
    n_eGenes_ot[j,i] = length(ot_ij_eGenes)

    # overlap proportion tables
    eGenes_overlap = intersect(ot_ij_eGenes, cs_ij_eGenes)
    
    prop_mat_ot[j,i] = length(eGenes_overlap)/length(ot_ij_eGenes)
    prop_mat_cs[j,i] = length(eGenes_overlap)/length(cs_ij_eGenes)

    union_eGenes = union(ot_ij_eGenes, cs_ij_eGenes)
    prop_mat_union[j,i] = length(eGenes_overlap)/length(union_eGenes)
    
    # positive/negative by other method and CSeQTL.
    pp = length(eGenes_overlap)
    pn = length(setdiff(ot_ij_eGenes, eGenes_overlap))
    np = length(setdiff(cs_ij_eGenes, eGenes_overlap))
    nn = length(setdiff(overlap_considered, union_eGenes))
    
    stopifnot(pp+pn+np+nn == length(overlap_considered))
    
    # ratio between observed and expected
    ratio_obs_vs_exp[j,i] = (pp*(pp+pn+np+nn))/((pp+pn)*(pp+np))
    
    # relative ratio, compare the true discovery rate across cell types.
    TDR_cs_ij = pp/(pp + np)
    relative_ratios[j,i] = TDR_cs_ij/base_union_ratio
    
    # Fisher's exact test
    mat_test = matrix(c(pp, np, pn, nn), nrow = 2)
    rownames(mat_test) = c("BLUEPRINT eGenes", "BLUEPRINT Non-eGenes")
    colnames(mat_test) = c("CSeQTL eGenes", "CSeQTL Non-eGenes")

    cat("Other:", ot_ct, "CSeQTL:", cs_ct, "\n")
    print(mat_test)
    cat("\n")

    fisher_mat[j,i] = fisher.test(mat_test, 
                                  alternative = "greater")$p.value
    
    # get CSeQTL pvalue for the eGenes by the other method
    cs_result_all_ct = cs_result_all[cs_result_all$CELLTYPE == cs_ct,]
    stopifnot(all(ot_ij_eGenes %in% cs_result_all_ct$ENSG))
    
    ot_eGenes_CSeQTL_pvalues = 
      cs_result_all_ct[match(ot_ij_eGenes, 
                          cs_result_all_ct$ENSG),]$permutation_PVAL
    
    # Use p-value distribution to estimate the proportion of null
    pi0_hat = get_pi0(ot_eGenes_CSeQTL_pvalues)
    pi0_hat = min(1, pi0_hat)
    pi1_hat_mat_ot[j,i] = 1 - pi0_hat

    # p-value histogram
    df_ct_plot_pvalues = data.frame(pvalue = ot_eGenes_CSeQTL_pvalues)
    
    p_ct_list[[j]] = ggplot(df_ct_plot_pvalues, aes(x=pvalue)) +
                     geom_histogram(color="darkblue", fill="lightblue", 
                                    breaks=seq(0,1,by=0.02)) + 
                     ggtitle(paste0(Other_method, ": ", ot_ct, 
                                    "\nCSeQTL: ", cs_ct, 
                                    "\npi_0: ", signif(pi0_hat, 2)))
  }
  
  print(ggarrange(plotlist=p_ct_list, nrow = 2, ncol = 4))
  
}

dev.off()

n_eGenes_ot
```


## Plots
```{r fig.width=4.2, fig.height=2.5}
theme1 = theme(axis.text.x = element_text(angle = 60, vjust = 1, 
                                   size = 11, hjust = 1),
               axis.text.y = element_text(size = 11))

# among eGenes of other method, what proportion was recovered by CSeQTL
melted_prop_mat_ot = reshape2::melt(prop_mat_ot,
                          varnames=c("CSeQTL", Other_method))
names(melted_prop_mat_ot)[1:2] = c("CSeQTL", Other_method)

round(prop_mat_ot,2)

ggplot(data = melted_prop_mat_ot, 
       aes_string(x="CSeQTL", y=Other_method, fill="value")) + 
  geom_tile() + theme_classic() + 
  scale_fill_gradient(low = "white", high = "red") + 
  ggtitle(paste("Prop. overlap among", 
                Other_method, "eGenes")) + theme1

melted_prop_mat_cs = reshape2::melt(prop_mat_cs,
                          varnames=c("CSeQTL", Other_method))

round(prop_mat_cs, 2)
ggplot(data = melted_prop_mat_cs, 
       aes_string(x="CSeQTL", y=Other_method, fill="value")) + 
  geom_tile() + theme_classic() + 
  scale_fill_gradient(low = "white", high = "red") +  
  ggtitle("Prop. overlap among CSeQTL eGenes") + theme1


melted_prop_mat_union = reshape2::melt(prop_mat_union, 
                              varnames=c("CSeQTL", Other_method))

round(prop_mat_union, 2)
ggplot(data = melted_prop_mat_union, 
       aes_string(x="CSeQTL", y=Other_method, fill="value")) + 
  geom_tile() + theme_classic() + 
  scale_fill_gradient(low = "white", high = "red")+ 
  ggtitle("Prop. overlap among union of eGenes") + theme1


melted_ratio = reshape2::melt(ratio_obs_vs_exp,
                    varnames=c("CSeQTL", Other_method))

round(ratio_obs_vs_exp, 2)
ggplot(data = melted_ratio, 
       aes_string(x="CSeQTL", y=Other_method, fill="value")) + 
  geom_tile() + theme_classic() + 
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 1) + 
  ggtitle("ratio of observed/expected overlap") + theme1


melted_relative_ratios = reshape2::melt(relative_ratios,
                            varnames=c("CSeQTL", Other_method))

round(relative_ratios, 2)
ggplot(data = melted_relative_ratios, 
       aes_string(x="CSeQTL", y=Other_method, fill="value")) + 
  geom_tile() + theme_classic() + 
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 1) + 
  ggtitle("relative ratio") + theme1

fisher_mat_cut = fisher_mat
fisher_mat_cut[fisher_mat < (10^(-10))] = 10^(-10)

melted_fisher_mat = reshape2::melt(-log10(fisher_mat_cut),
                      varnames=c("CSeQTL", Other_method))

round(-log10(fisher_mat_cut), 2)
ggplot(data = melted_fisher_mat, 
       aes_string(x="CSeQTL", y=Other_method, fill="value")) + 
  geom_tile() + theme_classic() + 
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = -log10(0.05), name="-log10(pvalue)") + 
  ggtitle("-log10(pvalue) for overlap") + theme1

melted_pi1 = reshape2::melt(pi1_hat_mat_ot, 
                varnames=c("CSeQTL", Other_method))

round(pi1_hat_mat_ot,3)
ggplot(data = melted_pi1, 
       aes_string(x="CSeQTL", y=Other_method, fill="value")) + 
  geom_tile() + theme_classic() + 
  scale_fill_gradient(low = "white", high = "red") +  
  ggtitle(paste("pi1 of", Other_method, "eGenes")) + 
  theme1
```

## Write out results

```{r}
write.csv(as.data.frame(prop_mat_cs), row.names = TRUE, 
          file = sprintf("results/step1_%s_prop_overlap_among_CSeQTL.csv",
                         config))

write.csv(as.data.frame(ratio_obs_vs_exp), row.names = TRUE, 
          file = sprintf("results/step1_%s_ratio_obs_vs_exp.csv",
                         config))

write.csv(as.data.frame(relative_ratios), row.names = TRUE, 
          file = sprintf("results/step1_%s_relative_ratios.csv",
                         config))  

write.csv(as.data.frame(fisher_mat), row.names = TRUE, 
          file = sprintf("results/step1_%s_overlap_fisher_pvalue.csv",
                         config))
```

# Session information
```{r}
gc()

sessionInfo()
```



